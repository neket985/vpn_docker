## WARNING

В случае наличия на сервере нескольких ip-адресов, необходимо создать в докере сеть и прописать правило в iptables. Если же на сервере один ip-адрес, то действия 2-4 не обязательны

## 1) Установка docker и docker-compose на сервер

(команды по установке обычно гуглятся)

## 2) Создание сети типа bridge в докере

```
docker network create --driver bridge -o "com.docker.network.bridge.host_binding_ipv4"="{ip}" -o "com.docker.network.bridge.enable_ip_masquerade"="false" -o "com.docker.network.bridge.name"="{bridge1}" {bridge1}
```

в данной команде необходимо заменить:

* {ip} на тот внешний ip-адрес, который должен соответствовать настраиваемому впн-у
* {bridge1} на название сети в докере (название может быть любым, но я обычно называю сеть так же, как контейнер, но с припиской постфикса "b". например контейнер называется mars, сеть для него marsb)

Посмотреть список сетей в докере можно командой

```
docker network ls
```

Посмотреть детальную информацию о сети в докере можно командой

```
docker network inspect {bridge1}
```

Удалить сеть в докере можно командой

```
docker network rm {bridge1}
```

## 3) Установка правила в iptables

Установка правил в iptables необходимо для связывания внешней сети и сети докера. На каждую сеть, создаваемую в докере, нужно прописывать следующее правило:

```
sudo iptables -t nat -A POSTROUTING -s {subnet} ! -o {bridge1} -j SNAT --to-source {ip}
```

в данной команде необходимо заменить:

* {ip} и {bridge1} те же, что в настройках докер сети
* {subnet} необходимо взять из детальной информации о сети в докере (см. выше). Пример, как может выглядеть значение этого параметра: "172.18.0.0/16"

Посмотреть список правил в iptables можно командой

```
iptables -t nat -v -L POSTROUTING -n --line-number
```

Удалить правило из iptables можно командой

```
iptables -t nat -D POSTROUTING {number}
```

в данной команде необходимо заменить:

* {number} на номер записи в списке правил, полученный из команды выше

## 4) Сохранение установленных правил в iptables

Если устанавливаемые правила не созранить, то при перезапуске сервера они сбросятся к исходным, что может негатичвно повлиять на работоспособность впн-ов. Для сохранения правил необходимо установить
утилиту iptables-persistent следующец командой:

```
sudo apt-get install iptables-persistent
```

после успешной установки утилиты можно сохранять правила. \
для сервера с установленной ОС ubuntu 16.04

```
sudo netfilter-persistent save
```

Если команда не сработала, можно попробовать эту :)

```
sudo iptables-persistent save
```

## 5) Настройка openvpn контейнера

Подробный гайд по настройке впн-а можно глянуть в статье https://habr.com/ru/post/354632/
Здесь будет представлены выдержка для быстрой настройки при уже имеющемся представлении и опыте.

1) Создаем директорию под впн
2) Переходим в директорию
3) Создаем файл docker-compose.yml
4) Наполняем файл содержимым:

```dockerfile
version: '2'
services:
  openvpn:
    cap_add:
     - NET_ADMIN
    image: kylemanna/openvpn
    container_name: {openvpn_name}
    ports:
     - "1194:1194/udp"
    restart: always
    volumes:
     - ./openvpn-data/conf:/etc/openvpn
networks:
  default:
    external:
      name: {bridge1}
```

В содержимом файла необходимо заменить:

* {openvpn_name} на название контейнера (пример mars)
* {bridge1} на название созданной сети в докере

Если при настройке впн-а сеть не создавалась, то из фала можно вообще удалить фрагмент "networks"

5) Выполняем следующие команды по очереди
6) ```docker-compose run --rm openvpn ovpn_genconfig -u udp://{ip}```
7) ```docker-compose run --rm openvpn ovpn_initpki```
8) ```docker-compose up -d openvpn```
9) ```docker-compose run --rm openvpn easyrsa build-client-full {client_name} nopass```
10) ```docker-compose run --rm openvpn ovpn_getclient {client_name} > {client_name}.ovpn```

Комментарии по выполненным командам:

* Команда №6 генерирует серверную конфигурацию впн-а и складывает её в директорию ./openvpn-data/conf. В команде надо заменить {ip} на внешний ip-адрес настраиваемого впн-а
* Команда №7 создает секретные ключи для шифрования трафика (или что-то типа того)
* Команда №8 поднимает контейнер. На этом этапе впн-сервер уже поднят и работает во всю. Остается создать клиентов
* Команда №9 создает конфигурацию клиента для дальнейшео подключения к серверу. фрагмент {client_name} - это название клиента. Обычно я назывваю его так же, как контейнер, так как обычно нам нужно
  создавать лишь одного клиента для одного сервера. Фрагмент nopass говорит о том, что подключение будет без пароля (так бухгалтерам меньше мороки)
* Команда №10 выгружает конфигурацию из докер-контейнера в файловую систему сервера, с которого мы все эти операции выполняем. Нужно это, чтобы мы могли в дальнейшем скачать эту конфигурацию себе на
  комп и подключиться к впн-у

## 6) Установка ip forwarding

Данная операция необходима, чтобы впн на сервере работал корректно и мог "делиться" своим ip-адресом. Следующая команда требует выполнения лишь единожды на сервере (т.е. если на сервере
устанавливается несколько впн-ов на разнвые ip, то forwarding устанавливается один раз)
Команда для установки ip forwarding:

```
sysctl -w net.ipv4.ip_forward=1
```
